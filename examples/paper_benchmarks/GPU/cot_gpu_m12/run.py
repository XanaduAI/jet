import quimb.tensor as qtn
import cotengra as ctg
import time
import numpy as np

from opt_einsum import contract, contract_expression, contract_path, helpers
from opt_einsum.paths import linear_to_ssa, ssa_to_linear

import pandas as pd
import numpy as np

def read_cotengra_file(filename):
    df = pd.read_csv(filename, sep=' ', header = None)
    tensors = []
    for i in range(len(df[0])):
        # print(df[3][i])
        tens_data = df[3][i].replace("[","").replace("]","").replace("'","")
        tens_data = [complex(s) for s in tens_data.split(',')]                
        tens_shape = df[2][i].replace("[","").replace("]","").replace("'","")
        tens_shape = [int(s) for s in tens_shape.split(',')]
        tens_tags = df[0][i].replace("[","").replace("]","").replace("'","")
        tens_tags = [str(s) for s in tens_tags.split(',')]
        tens_inds = df[1][i].replace("[","").replace("]","").replace("'","")
        tens_inds = [str(s) for s in tens_inds.split(',')]
        data = np.array(tens_data).reshape(tens_shape)
        inds = tens_inds
        tags = tens_tags
        tensors.append(qtn.Tensor(data, inds, tags))
    return qtn.TensorNetwork(tensors)

output_inds = []

m12_path = ((61,186),(60,410),(30,96),(106,412),(411,413),(105,355),(145,146),(415,416),(414,417),(29,95),(418,419),(94,354),(93,185),(421,422),(381,423),(383,385),(424,425),(420,426),(62,382),(139,428),(31,429),(427,430),(0,273),(276,432),(226,307),(344,434),(433,435),(192,195),(229,233),(437,438),(436,439),(148,440),(431,441),(193,259),(230,443),(227,374),(274,445),(444,446),(442,447),(107,147),(108,449),(448,450),(311,375),(194,308),(452,453),(275,279),(228,455),(454,456),(198,239),(232,458),(457,459),(360,460),(451,461),(2,313),(462,463),(1,345),(464,465),(277,281),(466,467),(315,321),(286,469),(294,333),(470,471),(468,472),(4,316),(363,474),(473,475),(312,361),(476,477),(280,287),(478,479),(260,278),(338,481),(197,235),(231,483),(482,484),(150,485),(480,486),(5,318),(487,488),(3,346),(489,490),(282,289),(491,492),(196,200),(149,494),(493,495),(32,64),(63,497),(33,498),(97,109),(187,500),(499,501),(496,502),(386,391),(503,504),(234,241),(505,506),(12,370),(328,508),(329,509),(507,510),(13,331),(511,512),(8,323),(367,514),(322,515),(513,516),(317,364),(517,518),(288,296),(519,520),(10,324),(9,522),(521,523),(209,236),(243,525),(265,290),(377,527),(526,528),(283,339),(202,261),(530,531),(529,532),(325,347),(533,534),(6,535),(14,536),(524,537),(263,376),(264,340),(539,540),(538,541),(330,335),(542,543),(163,164),(544,545),(216,242),(250,547),(267,297),(378,549),(548,550),(546,551),(201,208),(552,553),(155,156),(554,555),(115,188),(556,557),(16,17),(558,559),(392,398),(99,561),(560,562),(128,129),(83,564),(171,172),(141,566),(565,567),(563,568),(77,407),(140,570),(569,571),(121,122),(572,573),(161,162),(574,575),(207,215),(576,577),(249,255),(379,579),(221,269),(302,581),(580,582),(578,583),(69,70),(584,585),(113,114),(586,587),(153,154),(588,589),(199,206),(590,591),(240,248),(592,593),(295,301),(594,595),(334,337),(596,597),(44,45),(598,599),(75,76),(600,601),(119,120),(602,603),(159,160),(604,605),(205,213),(606,607),(169,170),(608,609),(214,220),(610,611),(254,258),(380,613),(271,305),(224,615),(614,616),(612,617),(18,19),(618,619),(247,253),(620,621),(300,304),(622,623),(20,352),(336,625),(624,626),(23,397),(627,628),(88,142),(133,630),(134,178),(177,632),(631,633),(629,634),(175,176),(635,636),(219,223),(637,638),(225,257),(272,640),(306,353),(641,642),(639,643),(37,38),(644,645),(50,51),(646,647),(21,390),(648,649),(42,43),(650,651),(25,402),(652,653),(54,55),(654,655),(136,137),(91,657),(143,181),(182,659),(658,660),(656,661),(58,406),(662,663),(27,57),(405,665),(396,666),(664,667),(92,144),(191,669),(138,184),(183,671),(670,672),(59,104),(673,674),(28,675),(668,676),(179,180),(677,678),(135,190),(89,680),(56,103),(90,682),(681,683),(679,684),(26,404),(685,686),(53,87),(86,688),(687,689),(81,82),(690,691),(49,401),(692,693),(24,52),(694,695),(67,68),(696,697),(388,395),(36,699),(698,700),(384,389),(22,702),(48,703),(35,704),(701,705),(73,74),(706,707),(41,394),(40,709),(708,710),(222,252),(256,712),(303,343),(270,714),(713,715),(711,716),(126,127),(717,718),(167,218),(168,720),(719,721),(79,80),(722,723),(47,399),(724,725),(46,400),(726,727),(110,152),(356,729),(98,730),(65,66),(34,732),(731,733),(111,151),(112,735),(734,736),(728,737),(117,118),(738,739),(131,132),(740,741),(84,85),(742,743),(71,72),(744,745),(268,298),(217,747),(245,251),(342,749),(748,750),(326,369),(751,752),(237,309),(292,754),(284,314),(348,756),(755,757),(350,758),(753,759),(203,211),(760,761),(358,362),(285,763),(11,327),(764,765),(762,766),(7,366),(365,768),(320,769),(767,770),(157,158),(262,772),(771,773),(204,246),(238,775),(774,776),(293,299),(777,778),(351,373),(779,780),(15,371),(372,782),(332,783),(781,784),(244,341),(310,786),(266,291),(210,788),(787,789),(319,349),(790,791),(368,792),(785,793),(116,357),(794,795),(101,409),(78,797),(123,359),(798,799),(165,166),(124,125),(801,802),(800,803),(796,804),(173,174),(212,806),(805,807),(130,189),(808,809),(746,810),(100,387),(102,403),(812,813),(811,814),(39,815),(393,816),(408,817))

m12_path_linear = ssa_to_linear(m12_path)

tn = read_cotengra_file("m12_slowdown.cotengra")
tn.astype_('complex64')
print(tn)

start = time.time()
res = tn.contract(all, optimize=m12_path_linear, backend='jax')
end = time.time()
print("time = " + str(end-start))

start = time.time()
res = tn.contract(all, optimize=m12_path_linear, backend='jax')
end = time.time()
print("time = " + str(end-start))
print(f"res={res}")
